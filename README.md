Google掃除機(仮称) Google Search Cleaner
========================================

Googleの検索結果から特定のページを非表示にするGreasemonkey用ユーザースクリプト

## 概要

Google掃除機(仮称)は、Googleの検索結果から特定のページを非表示にするGreasemonkey用ユーザースクリプトです。現在ウェブ検索結果・画像検索結果に対応しています。
本スクリプトは以下の機能を有しています。
* 検索結果を非表示にする条件を詳細に指定可能
* 条件に合致した検索結果について非表示にする以外の動作(警告の表示など)を行う
* 条件とそれに合致した検索結果に対する操作を合わせたルールの集まり(ルールセット)の複数作成・管理機能
* 検索結果からのルール作成機能
* 検索語句無視(未指定: ○○○)対策機能
* 2ページ目以降「もしかして:」を隠す機能
* 「関連する検索キーワード」(サジェスト)への「マイナス検索」の適用機能

## 免責事項
このスクリプトはGoogleとは無関係な個人が製作したものです。
作者はこのスクリプトが永続的に使用可能であることを保証しません。
特に、Google側の仕様変更によりスクリプトが正常に機能しなくなる可能性があります。

このスクリプトを使用したことに起因するいかなる問題や損害に対して、作者はその責任を負いません。

## その他の注意事項
Google検索における動作が確実に遅くなります。

Googleのインスタント検索機能をオフにすることを推奨します。

仕様が突然変更される場合があるため、Greasemonkeyの自動更新をオフにすることを推奨します。

予期せぬ不具合による設定の消失に備え、「バックアップ」機能を使用して定期的に設定のバックアップをすることをお勧めします。

Googleの検索結果を読み込んでから本スクリプトによる処理が完了するまで時間がかかる場合があり、見たくないものが一瞬表示されることがあります。

設定のエクスポート時には、スクリプトにより動的に生成したデータを「ファイルのダウンロード」という形で取得できるようにしています。(blobリソース)
また、インポート時には FileReader オブジェクトを用いてユーザーが指定したファイルを読み取ります。
そのため、設定のインポート/エクスポート時にファイルをダウンロードまたはアップロードするような画面が表示されますが、外部のサーバーとの通信は、必要なライブラリ(jQuery 2.2.0)の取得を除き一切行っておりません。

Googleの言語設定が「日本語」以外の場合は正常に動作しない可能性があります。また、日本語以外によるサポートも不十分です。

For non-Japanese speakers: This script might not work properly if you are using non-Japanese version of Google. User support in non-Japanese language is also very poor.

## システム要件
* Mozilla Firefox (バージョン46以降)
* Greasemonkey (バージョン3.8以降)

## インストール方法
GreasemonkeyをインストールしたFirefoxで `Google_Search_Cleaner.user.js` を開くとインストール画面が表示されます。表示されている内容を理解したら「インストール」をクリックしてください。

Firefoxの「ツール」→「アドオン」(またはCtrl+Shift+A)でアドオンマネージャを開き、「ユーザースクリプト」タブに「Google掃除機(仮称)」が表示されていればインストール完了です。

## 簡単な使用例
ツールバーの「Greasemonkey」ボタン(猿のアイコン)の横の「▼」をクリックし、表示されたメニューから「ユーザスクリプトコマンド」→「Google掃除機 設定」を選択すると設定画面が開きます。

特定のサイトを非表示にしたい場合は、次の手順に従ってください。
1. 「対象」に「URL」、「検索方法」に「ドメイン」、「動作」に「非表示」または「完全に非表示」と指定する
2. 「条件文字列」に非表示にしたいサイトのドメイン名を入力する
3. 「挿入」をクリックする
4. 「変更を保存」をクリックする

本スクリプトが有効になると、検索画面や検索結果の左上に「GSC」と書かれた「結果表示ウィンドウ」が表示されます。

処理を行ったサイト・画像・関連語句が現在の検索結果に存在しない場合は「検索結果に問題なし」と表示されます。

サイト・画像・関連語句に何らかの処理を行った場合は「検索結果を処理済(クリックで切替)」と表示され、その下部に「検索結果」「画像」「関連語句」などのボタンが表示されます。各ボタンに書かれた数字は処理を行った項目の数を表します。

各ボタンをクリックすると表示/非表示を切り替えます。
(例えば、「動作」が「非表示」の場合、「検索結果」をクリックすると非表示になったサイトが「非表示ルール: example.com」のような形式で表示されます。)


## 各部の機能説明
### ルールセットの編集
上のリストボックスからルールセットを選択し、編集します。
ルールの「対象」「検索方法」「動作」「レベル」の仕様については末尾の「ルールの仕様」をご参照ください。

ルールセットの表では各行をクリックすることでルールを選択できます。
表示スペースの都合上、「動作」の列に表示される動作は略されます。各動作をポイントすると元の動作名が表示されます。
また、右端の「C」はコメントを表します。コメントが設定されている場合は「...」と表示され、そこをポイントするとコメントが表示されます。

「選択されたルールを移動」ではルールの順序を入れ替えることができますが、現状1つのルールのみが選択されている場合のみ使用できます。

水平線より下の各部に入力し、「挿入」をクリックするとルールを追加できます。1つのルールのみ選択されている場合はその次に挿入され、それ以外の場合はルールセットの末尾に挿入されます。

「上書」をクリックするとルールが上書きされます。複数のルールを選択していた場合は、値が入力されている列が一括で変更されます。

最下部の「変更を保存」をクリックしない限りルールセットの変更は適用されないので、操作を誤った場合は「変更を破棄」をクリックするかページを再読み込みしてください。

### ルールセットの管理
#### ルールセットの表示名/追加/削除
「現在のルールセットの表示名」では、現在のルールセットの表示名(ブロックされた検索結果の通知文などに表示されるもの)を変更できます。
「現在のルールセットの削除」をクリックすると、現在のルールセットが削除されます。ただし、現在のルールセットが唯一のものである場合は削除できません。

「キー」を指定して「新規ルールセットの追加」をクリックするとルールセットを追加できます。「キー」は既存のルールセットのものと重複しない文字列である必要があります。英単語などの略語を推奨します。また、「キー」は設定画面上から直接変更することができません。(設定を一度JSON形式でエクスポートし、キーを書き換えてから再びインポートするという方法ならば可能です。 )

#### インポート/エクスポート
外部のファイルからインポートして現在のルールセットに追加することができます。対応している形式は本スクリプトによりエクスポートされたJSONファイル、およびテキストファイルです。
テキストファイルは Personal Blocklist などで用いられる、URLを1行ずつ書いたものを想定しています。

また、「選択範囲をエクスポート」では、上の「ルールセットの編集」における選択範囲をJSON形式、およびテキストファイルとしてエクスポートできます。

テキストファイルとしてエクスポートした場合は「条件文字列」以外の情報が欠落します。

### 活動ログ
次の記録を見ることができます。
* 検索結果において適用されたルール
* 検索語句無視対策機能(有効になっている場合)
* 関連キーワードにおけるマイナス検索の適用(有効になっている場合)

T/KW(タイトル/キーワード)、URL、RS(ルールセット)の各列に[…]がある場合は、ポイントするとその列の情報が表示されます。
(表示しきれないのでこのような仕様としています)

最終的なルール以外にも該当したルールは全て表示されますが、最終的に適用されたルール以外には打ち消し線が付きます。

最終的に適用されたルールが「完全に非表示」の場合は「マッチした文字列」「タイトル/キーワード」「URL」は表示されません。
(「完全に非表示」ルールは「○○○を絶対に見たくない!」という需要を満たすために存在しているためこのような仕様としています)

### その他の設定
結果表示ウィンドウのスクロール追従やアニメーション、追加機能の有効・無効を切り替えることができます。

#### 検索結果にクイックブロックボタンを表示
検索結果の横に、クリックすることにより検索結果を元にしたルールを作成できるボタンを追加します。デフォルトで無効。

#### 画像検索のチェック
画像検索結果(ウェブ検索結果における画像ではない)についてチェックを行います。デフォルトで有効。

#### プレースホルダにコメントを表示する
ルールが適用された際に表示されるルールセット名の後ろに「\[コメント\]」を追加します。デフォルトで無効。(コメントが`#`で始まる場合はこの設定を有効にしても追加されません。)

#### 検索語句無視対策機能を有効にする
Googleでは検索の際に一部の検索語句が「未指定: ○○○」のような形で無視されることがあります。
検索語句無視が発生した際に、結果表示ウィンドウに「検索語句無視!」と表示し、完全検索を行うリンクを表示します。
また、「未指定: ○○○」を「無視されたキーワード: ○○○」に書き換え目立たせます。
デフォルトで有効。

#### 2ページ目以降「もしかして：」を隠す
「もしかして：」を2ページ目以降隠します。
デフォルトで有効。

#### サジェストに「マイナス検索」を適用
検索ボックスに入力した「マイナス検索」キーワードが関連キーワードに含まれる場合、その関連キーワードを非表示にします。
デフォルトで無効。

#### スクロールに追従する
結果表示画面・設定画面がスクロールに追従します。
デフォルトで有効。

#### アニメーション
表示・非表示の際にアニメーションします。
デフォルトで有効。

### バックアップ/復元/初期化
「ファイルにバックアップ」「ファイルから復元」では、現在の設定をJSON形式でバックアップ・復元します。
JSON形式のファイルを編集できる方は次の方法でルールセット編集を行うほうが早いかもしれません。
1. 「ファイルにバックアップ」で適当な場所に設定ファイルを保存する
2. 保存された設定ファイルの `"rules": [...]` を編集する
3. 編集が終わったら「全設定をファイルから復元」で設定を読み込ませる

「全設定を初期化」をクリックすると全ての設定が初期化されます。

**注意! この設定画面の全ての変更は「変更を保存」をクリックするまで保存されませんが、
「全設定の初期化」だけはすぐに適用されます。**

## ルールの仕様
条件とそれに合致した検索結果に対する操作を合わせた「ルール」の仕様を記します。

本スクリプトでは、次の4つの要素を設定することにより、「『URL』に『example.com』という『ドメイン名』が含まれていたら『非表示』にする」といったルールを記述できます。

1. 対象
    * URL
    * 説明文
    * タイトル
    * サジェスト
2. 条件文字列
3. 検索方法
    * ドメイン
    * 文字列
    * 文字列(先頭一致)
    * ワード
    * 正規表現
4. 動作
    * 完全に非表示
    * 非表示
    * 警告+説明文非表示
    * 警告
    * 通知
    * 許可

### 対象
#### URL
次のものが該当します。
* 検索結果の各サイトのURL
* 画像検索結果の「画像そのもの」のURL
* 画像検索結果の「画像を載せているサイト」のURL

これらのURLは、デコードされたものが検索に使用されます。
(例えば、`http://example.com/%E3%83%86%E3%82%B9%E3%83%88` というURLの場合、`http://example.com/テスト`が検索に使用されます。)

#### 説明文
検索結果の各サイトの説明文や抜粋が該当します。

#### タイトル
検索結果の各サイトのタイトルが該当します。

#### サジェスト
次のものが該当します。
* 検索キーワード入力時に提案される関連検索語句
* 検索結果に表示される「他のキーワード」「○○○に関連する検索キーワード」などの関連検索語句

### 検索方法
全ての検索方法において大文字・小文字は区別されません。

#### ドメイン名
「対象」が `http` で始まる場合、サブドメインごとの後方一致検索を行います。
例えば、条件文字列 `example.com` は、次のような「対象」にマッチします。
* `http://example.com/`
* `https://foo.example.com/index.html`
* `http://bar.example.com/`
しかし、次のような「対象」にはマッチしません。
* `http://some-example.com/`
また、`http` で始まらない「対象」にマッチすることはありません。(「対象」に「URL」を指定することを想定しています。)

#### 文字列
文字列の部分一致検索を行います。

#### 文字列(先頭一致)
文字列の先頭一致検索を行います。

#### ワード
指定された単語が「対象」にすべて存在するとルールが適用されます。

単語は「半角スペース」で区切って指定します。
各単語に日本語(ひらがな・カタカナ・漢字)が含まれない場合は単語単位で検索し、含まれる場合は部分一致検索を行います。

例えば、条件文字列 `ほげ ふが` は `foobarほげふが` にマッチします。
また、条件文字列 `foo bar` は `foo bar baz` や `ほげふがfoo bar` にマッチしますが、`ほげふがfoobar` にはマッチしません。

#### 正規表現
正規表現検索を行います。「条件文字列」への入力時に「`\`(バックスラッシュ)」を重ねて書く必要はありません。また、正規表現リテラルではなく文字列として処理されます。
例えば `regexp\.(foo\.|bar\.)?example\.com` という正規表現を指定したい際に次のように入力しても正常に動作しません。
* `regexp\\.(foo\\.|bar\\.)?example\\.com`
* `/regexp\.(foo\.|bar\.)?example\.com/i`

### 動作
1. 非表示
検索結果: 非表示⇔(ルールの名称): (マッチした文字列)
検索結果に表示される画像: 非表示⇔淡色表示
画像検索結果: 非表示⇔淡色表示
サジェスト: 非表示⇔(ルールの名称)

2. 完全に非表示
検索結果: 常に非表示
検索結果に表示される画像: 常に非表示
画像検索結果: 常に非表示
サジェスト: 非表示⇔(ルールの名称)

3. 警告+説明文非表示
検索結果: 「⚠(ルールの名称)」と表示、説明文非表示⇔「⚠(ルールの名称)」の表示を付加
検索結果に表示される画像: 淡色表示⇔通常表示
画像検索結果: 淡色表示⇔通常表示
サジェスト: 非表示⇔表示(打ち消し線)

4. 警告
検索結果: 「⚠(ルールの名称)」の表示を付加
検索結果に表示される画像: 淡色表示⇔通常表示
画像検索結果: 淡色表示⇔通常表示
サジェスト: 非表示⇔表示(打ち消し線)

5. 通知+説明文非表示
検索結果: 「(ルールの名称)」と表示、説明文非表示⇔「(ルールの名称)」の表示を付加
検索結果に表示される画像: 通常表示
画像検索結果: 通常表示
サジェスト: 適用せず

6. 通知
検索結果 「(ルールの名称)」の表示を付加
検索結果に表示される画像: 通常表示
画像検索結果: 通常表示
サジェスト: 適用せず

7. 許可
何も行いません。後述する「レベル」と併用することを前提とします。

### レベル
整数を指定します。(デフォルトは0)
あるレベルのルールに合致した際にのみ次のレベルのルールについてチェックが行われます。

例えば、次の2つのルールが設定されていたとします。

    対象|検索方法|動作  |Lv|条件文字列
    ----+--------+------+--+----------------
    URL |ドメイン|非表示| 0|example.com      ……(A)
    URL |ドメイン|許可  | 1|good.example.com ……(B)

この場合、`foo.example.com`や`bar.example.com`はルール(A)に合致しますが、(B)には合致しないため、非表示になります。
しかし、`good.example.com`はルール(A)(B)の双方に合致するため、非表示にはなりません。
また、ルール(A)に合致しない場合、ルール(B)のチェックは行われません。

### コメント
追加情報を指定できます。「プレースホルダにコメントを表示する」機能が有効だとブロックされた際の通知文に追加されます。
(`#`で始まるコメントは「プレースホルダにコメントを表示する」が有効であっても表示されません。)

### 複数のルールに合致した際の仕様
複数のルールに合致した際には、より厳しい動作が適用されます。
動作の厳しさは次の通りです。(箇条書きの数字が大きいほど厳しくなります。)
1. 許可
2. 通知
3. 警告
4. 通知+説明文非表示
5. 警告+説明文非表示
6. 非表示
7. 完全に非表示

例えば、「警告」が適用されるルールと「非表示」が適用されるルールに同時に合致した場合は、後者が適用されます。

## ライセンス
[GPL v3](http://www.gnu.org/copyleft/gpl.html)

## 作者
[たかだか。(TakaDaka.)](https://twitter.com/djtkdk_086969)